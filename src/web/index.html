<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ST4305 RAG (Ollama)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body{font-family:system-ui, sans-serif; max-width: 900px; margin: 2rem auto; padding: 0 1rem;}
      label{display:block; margin:.5rem 0;}
      /* input,textarea{width:100%; padding:.6rem; border:1px solid #ddd; border-radius:8px;} */
      input, textarea { display:block; width:100%; padding:.6rem; border:1px solid #ddd; border-radius:8px; }
      button{margin:.5rem .5rem .5rem 0; padding:.6rem .9rem; border-radius:8px; cursor:pointer;}
      pre{white-space:pre-wrap; background:#f6f8fa; padding:1rem; border-radius:8px;}
      small{color:#555}
      .actions { margin-top:.5rem; display:flex; gap:.5rem; flex-wrap:wrap; }
    </style>
  </head>
  <body>
  <h2>ST4305 RAG (Ollama)</h2>
  <label>Consulta:</label>
  <input id="q" placeholder="ex.: comando para reiniciar o dispositivo" />
  <div class="actions">    
    <button id="btnSearch">Buscar (retrieval)</button>
    <button id="btnRag">Consultar via RAG</button>
  </div>

  <div id="out" style="margin-top:1em;"></div>

  <script>
    async function post(path, body){
      const r = await fetch(path, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if(!r.ok) throw new Error(await r.text());
      return r.json();
    }

    const out = document.getElementById('out');
    const esc = s => (s||"").replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));

    // --- /search button ---
    document.getElementById('btnSearch').onclick = async ()=>{
      out.textContent = 'Consultando (retrieval)…';
      try{
        const data = await post('/search',{query:document.getElementById('q').value, top_k:5});
        const items = (data.results || []).map(r=>{
          
          console.debug(r.title)
          const title   = r.title || r.section || r.meta?.section_title || 'Sem título';
          const page    = (r.page ?? r.meta?.page_number);
          const endp    = r.meta?.end_page;
          const pRange  = (page && endp) ? `${page}–${endp}` : (page ?? '?');
          const snippet = r.snippet || '';
          const score   = Number(r.score ?? 0).toFixed(3);
          return `<li><b>${esc(title)}</b> [${esc(String(pRange))}] — score: ${score}<br><small>${esc(snippet)}</small></li>`;
        }).join('');
        out.innerHTML = `<h3>Resultados</h3><ol>${items}</ol>`;
      }catch(e){ out.textContent = 'Erro: ' + e.message; }
    };

    // --- /rag button ---
    document.getElementById('btnRag').onclick = async ()=>{
      out.textContent = 'Consultando via RAG…';
      try{
        const data = await post('/rag',{query:document.getElementById('q').value, top_k:5});
        out.innerHTML = `<h3>Resposta</h3><pre>${esc(data.answer || data.text || JSON.stringify(data,null,2))}</pre>`;
      }catch(e){ out.textContent = 'Erro: ' + e.message; }
    };
  </script>
</body>

</html>

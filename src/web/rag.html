<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ST4305 — RAG (Streaming)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body{font-family:system-ui, sans-serif; max-width:900px; margin:2rem auto; padding:0 1rem;}
      input{width:100%; padding:.6rem; border:1px solid #ddd; border-radius:8px}
      button{margin:.6rem .5rem .5rem 0; padding:.6rem 1rem; border-radius:8px; cursor:pointer}
      pre{white-space:pre-wrap; background:#f6f8fa; padding:1rem; border-radius:8px}
      small{color:#666}
    </style>
  </head>
  <body>
    <h1>RAG — Streaming</h1>
    <input id="q" placeholder="ex.: comando para reiniciar o dispositivo" />
    <div>
      <label hidden>Top-K <input id="topk" type="number" min="1" max="10" value="5" style="width:6rem"></label>
      <label>Temperatura <input id="temp" type="number" step="0.1" min="0" max="1.5" value="0.0" style="width:6rem"></label>
    </div>
    <button id="btnStart">RAG (stream)</button>
    <button id="btnStop">Parar</button>

    <div id="meta"></div>
    <h3>Resposta</h3>
    <pre id="ans"></pre>

    <script>
  let es = null;
  const esc = s => (s??"").toString().replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
  const ans  = document.getElementById('ans');
  const meta = document.getElementById('meta');

  // Marcadores a ocultar na UI
  const TAGS_RE = /<BEGIN_ANSWER>|<\/END_ANSWER>|<\/END_JSON>/g;

  document.getElementById('btnStart').onclick = () => {
    if (es) es.close();
    ans.textContent = '...';
    meta.innerHTML = '';

    const query = document.getElementById('q').value.trim();
    const top_k = document.getElementById('topk').value || '5';
    const temp  = document.getElementById('temp').value || '0';
    const qs = new URLSearchParams({ query, top_k, temperature: temp });

    es = new EventSource(`/rag/stream?${qs.toString()}`);

    // buffer para tokens (limpamos tags no buffer inteiro a cada update)
    let buf = '';

    es.onmessage = (ev) => {
      try {
        const msg = JSON.parse(ev.data);

        if (msg.type === 'meta') {
          const cites = (msg.contexts||[]).map((c,i)=>
            `<li>[${i+1}] ${esc(c.section_title)} — ${esc(c.page_range||'')}</li>`
          ).join('');

          // limpa tags do prompt antes de exibir
          const promptClean = (msg.prompt||'').replace(TAGS_RE, '');

          meta.innerHTML =
            (cites ? `<h3>Citações</h3><ol>${cites}</ol>` : '') +
            `<details><summary>Prompt</summary><pre>${esc(promptClean)}</pre></details>` +
            `<small>Top-1 score: ${msg.score_top1?.toFixed?.(3) ?? 'n/a'}</small>`;

          buf = '';
          ans.textContent = '';
        }

        else if (msg.type === 'token' || msg.type === 'chunk') {
          // Agrega e limpa tags no buffer completo (cobre tags divididas entre chunks)
          buf += (msg.delta || msg.data || '');
          const cleanBuf = buf.replace(TAGS_RE, '');
          ans.textContent = cleanBuf;
        }

        else if (msg.type === 'final') {
          // Se não houve streaming, usa a resposta final
          if (!buf) {
            const clean = (msg.answer || '').replace(TAGS_RE, '');
            ans.textContent = clean;
          } else {
            // garante limpeza final do buffer
            ans.textContent = buf.replace(TAGS_RE, '');
          }

          // Mostra JSON estruturado (formatado) se vier
          if (msg.answer_json) {
            const pretty = typeof msg.answer_json === 'string'
              ? msg.answer_json
              : JSON.stringify(msg.answer_json, null, 2);
            const det = document.createElement('details');
            det.innerHTML = `<summary>JSON</summary><pre>${esc(pretty)}</pre>`;
            meta.appendChild(det);
          }
        }

        else if (msg.type === 'error') {
          ans.textContent += `\n\n[erro] ${msg.message}`;
        }

        else if (msg.type === 'done') {
          es.close();
        }

      } catch (_) {
        // ignore parsing errors de mensagens parciais
      }
    };

    es.onerror = () => { if (es) es.close(); };
  };

  document.getElementById('btnStop').onclick = () => { if (es) es.close(); };
</script>

  </body>
</html>
